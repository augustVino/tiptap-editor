# 表格功能使用指南

本文档介绍如何使用编辑器的表格功能。

## 🎯 功能概述

TipTap 3.x 多人协作编辑器支持完整的表格功能，包括：
- 插入和删除表格
- 添加/删除行和列
- 合并和拆分单元格
- 表头行管理
- 单元格内富文本编辑
- 列宽调整

## 📝 使用方法

### 1. 插入表格

**方式 1**: 使用工具栏按钮
1. 点击工具栏上的表格图标 (📊)
2. 自动插入一个 3x3 的表格，带表头行
3. **浮动菜单会自动出现**在表格上方

**方式 2**: 使用编辑器命令
```typescript
editor.chain().focus().insertTable({
  rows: 3,
  cols: 3,
  withHeaderRow: true
}).run()
```

### 浮动操作菜单

当光标在表格内或选中表格时，会自动显示**浮动操作菜单**：

**菜单布局**:
```
[⬆行] [⬇行] [🗑行] | [⬅列] [➡列] [🗑列] | [合并] [拆分] [表头] | [🗑删除表格]
```

- **行操作**: 在上方/下方插入行，删除行
- **列操作**: 在左侧/右侧插入列，删除列
- **单元格**: 合并/拆分单元格，切换表头
- **表格**: 删除整个表格

### 2. 编辑表格内容

**在单元格中输入**:
- 点击任意单元格开始输入
- 支持所有文本格式：加粗、斜体、下划线等
- 支持多行文本

**Tab 键导航**:
- 按 `Tab` 键：移动到下一个单元格
- 按 `Shift + Tab`：移动到上一个单元格
- 自动按从左到右、从上到下的顺序移动

### 3. 表格操作（使用浮动菜单）

#### 行操作

**添加行**:
- 将光标放在任意单元格中
- 浮动菜单自动显示
- 点击"⬆行"在当前行**上方**插入新行
- 点击"⬇行"在当前行**下方**插入新行

**删除行**:
- 将光标放在要删除的行中
- 点击浮动菜单中的"🗑行"按钮
- 当前行将被删除

#### 列操作

**添加列**:
- 将光标放在任意单元格中
- 点击"⬅列"在当前列**左侧**插入新列
- 点击"➡列"在当前列**右侧**插入新列

**删除列**:
- 将光标放在要删除的列中
- 点击浮动菜单中的"🗑列"按钮
- 当前列将被删除

#### 单元格操作

**合并单元格**:
1. 选中多个相邻的单元格
2. 点击浮动菜单中的"合并"按钮
3. 选中的单元格合并为一个单元格
4. 如果无法合并，按钮会显示为禁用状态

**拆分单元格**:
1. 将光标放在已合并的单元格中
2. 点击浮动菜单中的"拆分"按钮
3. 单元格拆分为原始大小
4. 如果无法拆分，按钮会显示为禁用状态

#### 表头操作

**切换表头行**:
- 将光标放在表格内
- 点击浮动菜单中的"表头"按钮
- 第一行在普通行和表头行之间切换
- 表头行有特殊的样式（粗体 + 背景色）

#### 删除表格

**删除整个表格**:
- 将光标放在表格内任意位置
- 点击浮动菜单中的"🗑删除表格"按钮（红色）
- 整个表格被删除

### 4. 列宽调整

**拖动调整**:
- 将鼠标移动到列边界
- 鼠标指针变为调整大小图标
- 按住鼠标左键拖动调整列宽

## 🎨 表格样式

### 默认样式
- 边框：2px 实线，颜色 #ced4da
- 单元格内边距：6px 8px
- 表头背景：#f1f3f5
- 表头文字：粗体

### 选中单元格
- 半透明蓝色背景 rgba(200, 200, 255, 0.4)
- 用于指示当前选中的单元格

## ⌨️ 键盘快捷键

| 操作 | 快捷键 |
|------|--------|
| 下一个单元格 | Tab |
| 上一个单元格 | Shift + Tab |
| 退出表格 | 在最后一个单元格按 Tab |

## ✅ 测试清单

### 基础功能
- [ ] 插入 3x3 表格成功
- [ ] 表格显示正确（3行3列，第一行为表头）
- [ ] 可以在单元格中输入文本
- [ ] Tab 键可以在单元格间导航

### 行列操作
- [ ] 添加行成功，新行出现在当前行下方
- [ ] 删除行成功，表格行数减少
- [ ] 添加列成功，新列出现在当前列右侧
- [ ] 删除列成功，表格列数减少
- [ ] 删除到只剩一行/一列时仍能正常工作

### 单元格操作
- [ ] 选中多个单元格后可以合并
  - 测试方法：按住鼠标左键，从一个单元格拖动到相邻单元格
  - 预期结果：选中的单元格显示蓝色背景，"合并"按钮变为可点击状态
- [ ] 合并的单元格可以拆分回来
  - 测试方法：点击已合并的单元格，点击"拆分"按钮
  - 预期结果："拆分"按钮在合并单元格中为可点击状态
- [ ] 合并单元格后内容正确保留
- [ ] 拆分后的单元格大小正确

### 格式化
- [ ] 可以在单元格内应用加粗格式
- [ ] 可以在单元格内应用斜体格式
- [ ] 可以在单元格内应用其他文本格式
- [ ] 格式在单元格内正确显示

### 表头
- [ ] 切换表头行成功
- [ ] 表头行样式与普通行不同（粗体+背景色）
- [ ] 再次切换可以恢复为普通行

### 协作
- [ ] 多用户可以同时编辑表格
- [ ] 表格内容在用户间实时同步
- [ ] 表格结构（行列）在用户间实时同步
- [ ] 表格操作（添加/删除）在用户间实时同步

### 边界情况
- [ ] 创建大表格（如 10x10）性能正常
- [ ] 删除所有行/列时表格被删除
- [ ] 在表格前/后插入段落正常
- [ ] 复制粘贴表格正常
- [ ] 撤销/重做表格操作正常

## 🐛 已知限制

1. **列宽调整**: 当前仅支持可调整大小的表格，最小列宽为 1em
2. **表格嵌套**: 不支持表格内嵌套表格
3. **批量操作**: 不支持同时选中多行/多列进行批量删除
4. **自定义样式**: 单元格样式目前由全局 CSS 控制，不支持单独设置
5. **移动端**: 在移动设备上，列宽调整功能可能不可用

## 💡 使用技巧

1. **快速创建大表格**: 如需创建更大的表格，先插入 3x3，然后使用"行+"和"列+"扩展
2. **表头管理**: 使用第一行作为表头，应用粗体格式使其更明显
3. **数据对齐**: 使用文本对齐按钮调整单元格内容的对齐方式
4. **复杂内容**: 单元格内可以包含列表、代码块等复杂格式
5. **快速导航**: 使用 Tab 和 Shift+Tab 在表格内快速移动，提高编辑效率

## 🔧 编程接口

### 插入表格
```typescript
// 插入 5x4 表格，带表头
editor.chain().focus().insertTable({
  rows: 5,
  cols: 4,
  withHeaderRow: true
}).run()

// 插入 3x3 表格，无表头
editor.chain().focus().insertTable({
  rows: 3,
  cols: 3,
  withHeaderRow: false
}).run()
```

### 行操作
```typescript
// 在当前行前插入行
editor.chain().focus().addRowBefore().run()

// 在当前行后插入行
editor.chain().focus().addRowAfter().run()

// 删除当前行
editor.chain().focus().deleteRow().run()
```

### 列操作
```typescript
// 在当前列前插入列
editor.chain().focus().addColumnBefore().run()

// 在当前列后插入列
editor.chain().focus().addColumnAfter().run()

// 删除当前列
editor.chain().focus().deleteColumn().run()
```

### 单元格操作
```typescript
// 合并选中的单元格
editor.chain().focus().mergeCells().run()

// 拆分单元格
editor.chain().focus().splitCell().run()

// 切换表头单元格
editor.chain().focus().toggleHeaderCell().run()
```

### 表头操作
```typescript
// 切换表头行
editor.chain().focus().toggleHeaderRow().run()

// 切换表头列
editor.chain().focus().toggleHeaderColumn().run()
```

### 删除表格
```typescript
// 删除整个表格
editor.chain().focus().deleteTable().run()
```

### 检查状态
```typescript
// 检查光标是否在表格内
const isInTable = editor.isActive('table')

// 检查是否可以合并单元格
const canMerge = editor.can().mergeCells()

// 检查是否可以拆分单元格
const canSplit = editor.can().splitCell()

// 检查是否是表头单元格
const isHeader = editor.isActive('tableHeader')
```

## 🔍 技术实现细节

### 浮动菜单按钮状态管理

为了确保合并/拆分按钮能够正确反映当前选择状态，TableBubbleMenu 组件使用了以下机制：

1. **状态跟踪**: 使用 React `useState` 维护 `canMerge` 和 `canSplit` 状态
2. **事件监听**: 通过 `useEffect` 监听编辑器的两个关键事件：
   - `selectionUpdate`: 当用户选择变化时触发
   - `transaction`: 当编辑器状态发生任何变化时触发
3. **动态更新**: 在事件回调中调用 `editor.can().mergeCells()` 和 `editor.can().splitCell()` 重新检查按钮可用性
4. **自动清理**: 组件卸载时自动移除事件监听器，防止内存泄漏

**代码示例**:
```typescript
const [canMerge, setCanMerge] = useState(false)
const [canSplit, setCanSplit] = useState(false)

useEffect(() => {
  const updateButtonStates = () => {
    setCanMerge(editor.can().mergeCells())
    setCanSplit(editor.can().splitCell())
  }

  editor.on('selectionUpdate', updateButtonStates)
  editor.on('transaction', updateButtonStates)

  return () => {
    editor.off('selectionUpdate', updateButtonStates)
    editor.off('transaction', updateButtonStates)
  }
}, [editor])
```

### 单元格选择方式

**选择多个单元格进行合并**:
1. **鼠标拖拽**: 按住鼠标左键，从一个单元格拖动到另一个单元格
2. **选择范围**: 只能选择矩形区域的单元格（相邻的行和列）
3. **视觉反馈**: 选中的单元格会显示蓝色半透明背景
4. **按钮激活**: 当选择有效的合并区域时，"合并"按钮自动启用

**注意事项**:
- 单个单元格无法合并（"合并"按钮保持禁用）
- 只有已合并的单元格才能拆分（"拆分"按钮才会启用）
- 非矩形选择区域无法合并

## 📚 相关资源

- [TipTap Table Extension 文档](https://tiptap.dev/docs/editor/extensions/nodes/table)
- [项目 README](./README.md)
- [协作功能测试指南](./COLLABORATION_TESTING.md)
- [协作功能实现文档](./COLLABORATION_IMPLEMENTATION.md)

## 📄 许可证

MIT

---

**最后更新**: 2025-10-20
**功能状态**: ✅ 已完成
