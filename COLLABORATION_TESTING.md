# 协作功能测试指南

本文档提供完整的多人协作编辑器测试步骤和功能验证清单。

## 🚀 快速开始

### 1. 启动服务

```bash
# 终端 1: 启动 WebSocket 协作服务器
pnpm server

# 终端 2: 启动前端开发服务器
pnpm dev
```

### 2. 访问编辑器

在浏览器访问: http://localhost:3000

应用将默认打开**协作编辑器模式**。

## ✅ 功能测试清单

### 基础连接测试

- [ ] 页面加载无错误
- [ ] 右侧显示"网络状态"指示器
- [ ] 网络状态显示"已连接"（绿色）
- [ ] 在线用户列表显示当前用户

### 多用户协作测试

#### 准备工作
1. 打开 3-4 个浏览器标签页（或不同浏览器窗口）
2. 在每个标签页中设置不同的用户名：
   - 标签页 1: Alice
   - 标签页 2: Bob
   - 标签页 3: Charlie
   - 标签页 4: David

#### 测试项目

##### ✅ 在线用户列表
- [ ] 所有标签页都显示完整的在线用户列表
- [ ] 每个用户显示唯一的颜色圆点
- [ ] 用户名正确显示
- [ ] 关闭一个标签页，其他标签页的用户列表实时更新

##### ✅ 文档内容同步
- [ ] 在标签页 1 (Alice) 中输入文字
- [ ] 所有其他标签页实时显示相同内容
- [ ] 在标签页 2 (Bob) 中编辑文档
- [ ] 所有标签页看到 Bob 的编辑
- [ ] 多个用户同时编辑不同位置，无冲突
- [ ] 多个用户同时编辑相同位置，自动合并

##### ✅ 光标位置显示
- [ ] 在标签页 1 中移动光标
- [ ] 其他标签页显示 Alice 的光标（彩色竖线）
- [ ] 光标上方显示"Alice"标签
- [ ] 标签背景色与用户颜色一致
- [ ] 每个用户的光标颜色不同且稳定
- [ ] 光标位置实时跟随用户操作

##### ✅ 文本选择显示
- [ ] 在标签页 1 中选中一段文字
- [ ] 其他标签页显示 Alice 的选择区域（彩色高亮）
- [ ] 高亮颜色与用户颜色对应
- [ ] 取消选择时，高亮实时消失

##### ✅ 格式化操作同步
- [ ] 应用加粗格式 (Ctrl/Cmd+B)
- [ ] 所有标签页看到加粗效果
- [ ] 应用标题格式 (Ctrl/Cmd+Alt+1)
- [ ] 所有标签页看到标题效果
- [ ] 创建列表
- [ ] 所有标签页看到列表结构

##### ✅ 撤销/重做
- [ ] 在标签页 1 执行撤销操作
- [ ] 只影响标签页 1 的操作历史
- [ ] 不影响其他用户的操作

##### ✅ 网络中断恢复
- [ ] 打开开发者工具 -> Network
- [ ] 设置为 Offline 模式
- [ ] 网络状态显示"断开连接"（红色）
- [ ] 恢复网络连接
- [ ] 自动重新连接
- [ ] 网络状态恢复为"已连接"
- [ ] 文档自动同步最新内容

## 🎨 视觉效果验证

### 光标显示
每个用户的光标应该显示为：
- **彩色竖线**: 细线条，使用用户专属颜色
- **用户名标签**: 显示在光标上方，带圆角背景
- **标签样式**: 白色文字，背景色与光标颜色一致

### 选择区域
- **半透明高亮**: 选中文本显示彩色背景
- **颜色协调**: 与用户光标颜色一致
- **不影响阅读**: 半透明效果不遮挡文字

### 用户列表
- **颜色圆点**: 每个用户前显示彩色圆点
- **用户名**: 清晰可读
- **实时更新**: 用户进入/离开时即时更新

## 🔧 性能测试

### 延迟测试
- [ ] 在标签页 1 快速输入文字
- [ ] 观察其他标签页的延迟 (应 < 100ms)
- [ ] 光标移动响应流畅

### 并发测试
- [ ] 3-4 个用户同时快速编辑
- [ ] 无崩溃或错误
- [ ] 内容正确合并
- [ ] UI 保持响应

### 大文档测试
- [ ] 粘贴大量文字（1000+ 字）
- [ ] 同步速度可接受
- [ ] 光标位置准确
- [ ] 滚动流畅

## 🐛 已知限制

1. **WebSocket 服务器**: 当前使用简单的本地 WebSocket 服务器，生产环境需要更robust的解决方案
2. **用户身份**: 无身份验证，用户名可以重复
3. **历史记录**: 协作模式下的撤销/重做由 Yjs 管理，可能与单机模式行为不同
4. **IndexedDB**: 离线持久化功能在当前版本中已启用但未充分测试

## 📊 技术细节

### 协作栈
- **CRDT**: Yjs 13.6 - 冲突解决
- **传输**: y-websocket - WebSocket 同步
- **编辑器**: TipTap 3.7.2 + CollaborationCaret
- **持久化**: y-indexeddb - 本地存储

### 关键组件
1. **YjsProvider** (`src/collaboration/YjsProvider.tsx`): 管理 Yjs 文档和 WebSocket 连接
2. **AwarenessManager** (`src/collaboration/AwarenessManager.ts`): 用户状态同步
3. **CollaborationExtension**: TipTap 的 Yjs 集成
4. **CollaborationCaret**: 光标和选择显示

### CSS 类名
- `.collaboration-carets__caret`: 光标线条
- `.collaboration-carets__label`: 用户名标签
- `.collaboration-carets__selection`: 选择区域高亮

## 🆘 故障排查

### 问题: 用户列表为空
**可能原因**: WebSocket 服务器未启动
**解决方案**: 运行 `pnpm server`

### 问题: 无法连接
**可能原因**: 端口占用或防火墙
**解决方案**:
- 检查 1234 端口是否被占用
- 查看浏览器控制台错误信息

### 问题: 光标不显示
**可能原因**: CSS 未加载
**解决方案**:
- 刷新页面（硬刷新 Ctrl+Shift+R）
- 检查开发者工具 -> Elements 中是否有 `.collaboration-carets__*` 类

### 问题: 内容不同步
**可能原因**: WebSocket 连接断开
**解决方案**:
- 检查"网络状态"指示器
- 查看浏览器控制台 WebSocket 连接状态
- 重启 WebSocket 服务器

### 问题: 延迟高
**可能原因**: 本地网络或性能问题
**解决方案**:
- 关闭不必要的浏览器标签页
- 检查系统资源使用情况
- 考虑使用更快的 WebSocket 服务器

## 📝 测试报告模板

```
测试日期: ____________________
测试人员: ____________________
浏览器: ____________________

基础功能:
☐ 页面加载    ☐ 用户列表    ☐ 网络状态

协作功能:
☐ 内容同步    ☐ 光标显示    ☐ 选择高亮
☐ 格式同步    ☐ 并发编辑    ☐ 网络恢复

性能:
☐ 延迟 < 100ms    ☐ 并发无崩溃    ☐ 大文档流畅

问题记录:
__________________________________________________
__________________________________________________
__________________________________________________

总体评价: ☐ 通过  ☐ 有问题  ☐ 失败
```

## 🎓 更多资源

- [TipTap 官方文档](https://tiptap.dev/docs)
- [Yjs 文档](https://docs.yjs.dev/)
- [y-websocket 文档](https://github.com/yjs/y-websocket)
- [项目 README](./README.md)
- [快速开始指南](./QUICKSTART.md)
