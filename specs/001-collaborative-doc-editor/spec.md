# Feature Specification: 多人协作文档编辑器

**Feature Branch**: `001-collaborative-doc-editor`
**Created**: 2025-10-17
**Status**: Draft
**Input**: User description: "创建一个支持多人协作的多功能文档编辑器，基于tiptap + yjs。使用现代化简约大气的布局风格，继承多种基础能力，对齐市面主流产品，包括但不限于：如加粗、标题或内容、斜体、对齐方式、代码块、插入表格。你需要多考虑一下，如何更好的编排编辑器的架构，使其更便于拓展更利于维护。目前项目只是个初始的架子，仅仅安装了部分依赖，你可以只保持当前技术栈（typescript+react+vite），重构全部代码。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基础富文本编辑 (Priority: P1)

用户可以在编辑器中创建和编辑文档，使用基本的文本格式化功能（加粗、斜体、标题）来组织内容，实现个人文档编辑的核心需求。

**Why this priority**: 这是编辑器的最基础功能，是 MVP 的核心。没有基础编辑能力，其他协作功能都无法实现。单用户编辑场景可以独立交付价值。

**Independent Test**: 用户打开编辑器，输入文本，应用格式（加粗、斜体、标题），保存文档，刷新页面后内容保持不变。这个功能完全独立，不依赖协作功能。

**Acceptance Scenarios**:

1. **Given** 用户打开空白编辑器，**When** 输入文本并点击加粗按钮，**Then** 选中的文本变为粗体显示
2. **Given** 用户在编辑器中输入多行内容，**When** 选择某行并设置为"标题 1"格式，**Then** 该行以更大字号和粗体显示
3. **Given** 用户编辑了文档内容，**When** 刷新浏览器页面，**Then** 之前的编辑内容完整保留
4. **Given** 用户选中一段文本，**When** 依次应用加粗和斜体格式，**Then** 文本同时显示为粗斜体
5. **Given** 用户在编辑器中，**When** 使用键盘快捷键 Ctrl+B（Mac 上 Cmd+B），**Then** 选中文本切换粗体状态

---

### User Story 2 - 实时多人协作 (Priority: P2)

多个用户可以同时编辑同一文档，实时看到彼此的更改，包括光标位置和在线状态，实现团队协作场景。

**Why this priority**: 这是将编辑器从单用户工具升级为协作平台的关键功能。在基础编辑功能稳定后，协作能力是最重要的差异化特性。

**Independent Test**: 在两个不同的浏览器窗口中打开同一文档，在一个窗口中编辑内容，另一个窗口应立即（1秒内）显示更改。可以独立测试协作同步逻辑。

**Acceptance Scenarios**:

1. **Given** 用户A和用户B同时打开同一文档，**When** 用户A输入文本，**Then** 用户B在1秒内看到新内容出现
2. **Given** 两个用户在不同位置同时编辑，**When** 两人都输入内容，**Then** 两处更改都被保留且不丢失数据
3. **Given** 用户A在编辑文档，**When** 用户B加入编辑，**Then** 用户A看到"用户B已加入"的提示和B的光标位置
4. **Given** 用户A和B同时编辑同一段落，**When** 两人的编辑产生潜在冲突，**Then** 系统自动合并更改，两人的内容都保留
5. **Given** 用户A离线后重新连接，**When** 网络恢复，**Then** 离线期间的本地编辑自动同步到服务器，其他用户可见

---

### User Story 3 - 高级格式与内容对齐 (Priority: P3)

用户可以使用高级格式化选项，包括文本对齐（左对齐、居中、右对齐）、有序/无序列表、代码块，以组织复杂文档内容。

**Why this priority**: 这些功能增强内容表现力，但不影响核心编辑和协作能力。可以在基础功能稳定后逐步添加。

**Independent Test**: 用户在编辑器中创建包含多种格式的文档：标题居中、段落左对齐、代码块、列表。导出或刷新后格式保持。

**Acceptance Scenarios**:

1. **Given** 用户选中一段文本，**When** 点击居中对齐按钮，**Then** 该段落内容在编辑器中居中显示
2. **Given** 用户在编辑器中，**When** 点击代码块按钮并输入代码，**Then** 内容以等宽字体显示，带有代码高亮背景
3. **Given** 用户输入列表项，**When** 按下 Tab 键，**Then** 列表项缩进一级，形成嵌套列表
4. **Given** 用户在代码块中，**When** 输入多行代码并包含缩进，**Then** 代码格式和缩进完整保留

---

### User Story 4 - 表格插入与编辑 (Priority: P4)

用户可以在文档中插入表格，编辑单元格内容，添加/删除行列，以结构化方式展示数据。

**Why this priority**: 表格是复杂文档的常用功能，但实现复杂度较高。可以在核心功能完善后作为增值功能添加。

**Independent Test**: 用户插入一个3x3表格，填充内容，添加一行，删除一列，表格结构和内容正确维护。

**Acceptance Scenarios**:

1. **Given** 用户在编辑器中，**When** 点击"插入表格"并选择3行4列，**Then** 编辑器中出现一个3x4的空白表格
2. **Given** 用户光标在表格某单元格中，**When** 输入文本并应用粗体格式，**Then** 单元格内容正确显示为粗体
3. **Given** 用户选中表格某一行，**When** 点击"删除行"按钮，**Then** 该行被删除，表格重新调整
4. **Given** 用户光标在表格中，**When** 使用 Tab 键导航，**Then** 光标按从左到右、从上到下的顺序在单元格间移动

---

### Edge Cases

- **网络中断时**: 用户离线编辑的内容应本地保存，网络恢复后自动同步；协作状态应显示"离线"，重新连接后恢复
- **大量用户同时编辑**: 系统应处理至少10个用户同时编辑同一文档，性能不明显降级（编辑延迟<2秒）
- **冲突解决**: 两个用户同时编辑同一字符位置时，CRDT 算法应自动合并，不丢失任何用户的输入
- **大型文档**: 文档内容超过10000字或包含大量格式时，编辑器加载和编辑性能保持流畅（初始化<3秒，输入延迟<100ms）
- **空内容处理**: 新建文档或删除所有内容后，编辑器应显示占位提示文字，引导用户开始输入
- **快速连续操作**: 用户快速输入或快速应用多个格式时，不应出现卡顿或格式错误
- **浏览器兼容性**: 在 Chrome、Safari、Firefox 最新两个版本中功能和样式一致
- **移动设备**: 在移动设备上，编辑器应可用，但协作功能可能受限（优先桌面体验）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供文本格式化工具栏，包括加粗、斜体、下划线、删除线按钮，用户点击后应用对应格式
- **FR-002**: 系统必须支持至少三级标题（H1、H2、H3），用户可通过下拉菜单或快捷键设置段落为标题格式
- **FR-003**: 系统必须支持文本对齐方式设置（左对齐、居中、右对齐、两端对齐），默认为左对齐
- **FR-004**: 系统必须提供代码块功能，代码内容以等宽字体显示，保留缩进和空格，背景色与正文区分
- **FR-005**: 系统必须支持有序列表和无序列表，用户可通过按钮或快捷键创建列表，支持嵌套（至少两级）
- **FR-006**: 系统必须提供表格插入功能，用户可指定初始行列数（最大支持10x10），插入后可编辑单元格内容
- **FR-007**: 系统必须支持表格的行列操作，包括在当前位置前后插入行/列、删除选中行/列
- **FR-008**: 系统必须实现实时协作同步，用户的编辑操作（插入、删除、格式化）需在1秒内同步到所有在线协作者
- **FR-009**: 系统必须显示其他协作者的光标位置和选中范围，用不同颜色标识不同用户（至少支持5种区分色）
- **FR-010**: 系统必须在右上角或侧边栏显示当前在线用户列表，包括用户名称和在线状态指示器
- **FR-011**: 系统必须在用户离线时缓存本地编辑内容，网络恢复后自动同步到服务器
- **FR-012**: 系统必须将文档内容持久化存储，用户刷新页面或重新打开文档时，内容完整恢复
- **FR-013**: 系统必须提供撤销（Undo）和重做（Redo）功能，支持至少50步历史记录，快捷键为 Ctrl/Cmd+Z 和 Ctrl/Cmd+Shift+Z
- **FR-014**: 系统必须支持键盘快捷键：Ctrl/Cmd+B（加粗）、Ctrl/Cmd+I（斜体）、Ctrl/Cmd+U（下划线）
- **FR-015**: 系统必须在编辑器为空时显示占位提示文字（如"开始输入..."），用户开始输入后自动隐藏
- **FR-016**: 系统必须提供清晰的工具栏布局，所有格式化按钮在顶部水平排列，分组显示（文本格式/段落格式/插入内容）
- **FR-017**: 系统必须使用简约现代的视觉风格，工具栏按钮使用图标（配合工具提示文字），编辑区域最大化
- **FR-018**: 系统必须处理并发编辑冲突，使用 CRDT 算法确保所有用户的更改都被保留，无数据丢失

### Key Entities

- **Document (文档)**: 表示一个可编辑的文档实例，包含内容（JSON 格式的编辑器状态）、创建时间、最后修改时间、文档标题。每个文档有唯一标识符，可通过 URL 访问
- **Collaborator (协作者)**: 表示当前正在编辑文档的用户，包含用户标识（用户名或匿名ID）、光标颜色、在线状态、最后活跃时间。一个文档可有多个协作者
- **Edit Operation (编辑操作)**: 表示对文档的单次修改操作，包含操作类型（插入/删除/格式化）、位置信息、内容数据、时间戳、操作者标识。用于协作同步和冲突解决
- **Format (格式)**: 表示应用于文本或段落的样式，包含格式类型（加粗/斜体/标题/对齐等）、应用范围（起始位置、结束位置）、格式参数（如标题级别、对齐方向）
- **Table (表格)**: 表示文档中的表格结构，包含行数、列数、单元格数据（二维数组），每个单元格可包含格式化内容

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户从打开编辑器到可以开始输入的时间少于2秒（空白文档场景）
- **SC-002**: 用户应用文本格式（加粗、斜体等）后，格式在100毫秒内生效并显示
- **SC-003**: 多用户协作时，一个用户的编辑操作在1秒内同步到其他所有用户的编辑器
- **SC-004**: 系统支持至少10个用户同时编辑同一文档，每个用户的编辑延迟不超过2秒
- **SC-005**: 用户可以在5秒内完成插入表格操作（从点击按钮到表格出现在编辑器中）
- **SC-006**: 90% 的用户在首次使用时能够在1分钟内找到并使用基础格式化功能（加粗、标题、列表）
- **SC-007**: 文档内容在网络中断后的离线编辑，在网络恢复时100%成功同步，无数据丢失
- **SC-008**: 编辑器在包含5000字内容和5个表格的文档中，输入响应时间保持在50毫秒以内
- **SC-009**: 编辑器工具栏的图标和布局在桌面端（1920x1080）和笔记本端（1366x768）分辨率下都清晰易用
- **SC-010**: 用户执行撤销/重做操作后，文档状态准确回退/前进到对应历史版本，准确率100%

### Assumptions

- 用户身份识别采用简单的用户名输入或匿名ID（浏览器生成），不需要复杂的账号系统和身份验证
- 文档通过唯一的 URL（包含文档ID）分享，任何拥有 URL 的用户都可以访问和编辑（公开协作模式）
- 文档内容存储在本地浏览器（IndexedDB/LocalStorage）或简单的后端服务，优先保证协作同步性能
- 协作房间在首个用户打开文档时自动创建，最后一个用户离开时房间保留（文档持久化）
- 默认桌面优先体验，移动端支持基础编辑，但协作功能可能受限（如光标同步可能不显示）
- 使用 WebSocket 或 WebRTC 实现实时通信，网络要求稳定的互联网连接
- 协作者数量上限为50人（性能考虑），超过时新用户以只读模式加入
